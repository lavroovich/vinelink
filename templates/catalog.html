<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–í–∏–Ω–Ω–∞—è –ö–∞—Ä—Ç–∞ ‚Äî WineLink (cards upgraded)</title>
<link href="https://fonts.googleapis.com/css?family=Alegreya+SC:500,700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#faf7f0;
  --card-bg:#ffffff;
  --muted:#777;
  --accent:#2980b9;
  --gold:#ffd700;
  --glass: rgba(255,255,255,0.6);
}
*{box-sizing:border-box}
html,body{height:100%}
body { margin:0; padding:0; min-height:100vh; font-family:'Alegreya SC', sans-serif; background:var(--bg); color:#222; display:flex; flex-direction:column; }
header { width:100%; text-align:center; padding:10px 0; background:#fff; border-bottom:1px solid #e8e5e0; position:sticky; top:0; z-index:20; }
main { flex:1; padding:18px; max-width:1200px; margin:0 auto; }
h1 { font-size:1.6rem; text-align:center; margin-bottom:12px; color:#4a2e2e; }
.filters { display:flex; gap:10px; padding:10px; overflow-x:auto; background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.06); margin-bottom:16px; }
.filter-box { flex:0 0 auto; min-width:140px; display:flex; flex-direction:column; background:#fafafa; padding:8px; border-radius:8px; border:1px solid #ddd; transition:background 0.25s ease, border-color 0.25s ease; text-align:center; }
.filter-box label{font-size:0.75rem; font-weight:700; margin-bottom:6px}
.filter-box select, .filter-box input[type="text"]{ padding:7px; font-size:0.9rem; border-radius:6px; border:1px solid #ccc; background:#fff; font-family:inherit; width:100%; box-sizing:border-box; }
.filter-box input[type="checkbox"]{ transform:scale(1.2); margin-right:8px }

/* layout for lists */
.wine-list{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:14px; margin-bottom:18px; }
.wine-list-sorted{ display:flex; flex-direction:column; gap:10px; }

/* card */
.wine-card{ background:var(--card-bg); border-radius:14px; padding:12px; box-shadow:0 8px 30px rgba(0,0,0,0.06); cursor:pointer; transition:transform .25s cubic-bezier(.2,.8,.2,1), box-shadow .25s, opacity .25s; opacity:0; transform:translateY(12px) scale(.998); display:flex; gap:12px; align-items:flex-start; border:1px solid rgba(0,0,0,0.04); }
.wine-card.show{ opacity:1; transform:translateY(0) scale(1); }
.wine-card:hover{ transform: translateY(-6px) scale(1.01); box-shadow:0 14px 36px rgba(0,0,0,0.12); }

/* left column: badge / icon */
.card-left{ width:68px; min-width:68px; display:flex; flex-direction:column; align-items:center; gap:8px }
.id-badge{ font-size:0.8rem; padding:6px 8px; background:linear-gradient(90deg,#fff,#f6f6f6); border-radius:10px; border:1px dashed rgba(0,0,0,0.06); box-shadow:inset 0 -2px 6px rgba(0,0,0,0.02); }
.icon-pdf{ width:44px; height:44px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#fafafa,#fff); border-radius:10px; border:1px solid rgba(0,0,0,0.03); box-shadow:0 6px 18px rgba(0,0,0,0.03); }
.icon-pdf svg{ width:22px; height:22px; }
.copy-id{ font-size:0.7rem; color:var(--muted); cursor:pointer; user-select:none }
.copy-id:hover{ color:var(--accent); text-decoration:underline }

/* main content */
.card-content{ flex:1; display:flex; flex-direction:column; gap:6px }
.card-top{ display:flex; justify-content:space-between; align-items:flex-start; gap:8px }
.wine-name{ font-size:1.03rem; margin:0; font-weight:700; color:#3b2b2b }
.sparkling-pill{ font-size:0.75rem; padding:6px 8px; border-radius:999px; background:linear-gradient(90deg,var(--gold),#ffeb99); color:#2b1800; font-weight:700; box-shadow:0 4px 12px rgba(255,215,0,0.12); border:1px solid rgba(0,0,0,0.03) }
.main-info{ font-size:0.88rem; color:#333; font-weight:600 }
.extra-info{ font-size:0.79rem; color:var(--muted) }
.card-bottom{ display:flex; gap:8px; align-items:center; margin-top:6px }
.btn{ font-size:0.85rem; padding:7px 10px; border-radius:8px; border:none; cursor:pointer; background:transparent; transition:all .18s }
.btn-more{ background:linear-gradient(90deg,#fff,#f6f6f6); border:1px solid rgba(0,0,0,0.06); }
.btn-open{ background:linear-gradient(90deg,#eef7ff,#ffffff); border:1px solid rgba(41,128,185,0.12); color:var(--accent); font-weight:700 }

/* for sub-cards (sorted view) */
.wine-card.sub{ padding:8px 10px; border-radius:10px; box-shadow:0 6px 14px rgba(0,0,0,0.04); font-size:0.92rem }

/* highlight for sparkling card border */
.wine-card.sparkling{ border-image: linear-gradient(90deg,#ffd36a,#ffb84d) 1; box-shadow:0 10px 30px rgba(255,190,30,0.06) }

/* responsive tweaks */
@media (max-width:520px){
  .filters{ gap:6px }
  .card-left{ width:60px }
  .wine-name{ font-size:1rem }
}
</style>
</head>
<body>
<header>
    <img src="static/logo.jpg" alt="VineLink" style="max-width:150px;">
</header>
<main>
<h1>–í–∏–Ω–Ω–∞—è –ö–∞—Ä—Ç–∞</h1>

<div class="filters">
    <div class="filter-box">
        <label>–ü–æ–∏—Å–∫</label>
        <input id="filter-name" type="text" placeholder="–ò–º—è –≤–∏–Ω–∞">
    </div>
    <div class="filter-box">
        <label>–°—Ç—Ä–∞–Ω–∞</label>
        <select id="filter-country" multiple></select>
    </div>
    <div class="filter-box" id="filter-color-box">
        <label>–¶–≤–µ—Ç</label>
        <select id="filter-color" multiple></select>
    </div>
    <div class="filter-box">
        <label>–°–∞—Ö–∞—Ä</label>
        <select id="filter-sugar" multiple></select> 
    </div>
    <div class="filter-box">
        <label>–†–µ–≥–∏–æ–Ω</label>
        <select id="filter-region" multiple></select>
    </div>
    <div class="filter-box">
        <label>–°–æ—Ä—Ç –≤–∏–Ω–æ–≥—Ä–∞–¥–∞</label>
        <select id="filter-grape" multiple></select>
    </div>
    <div class="filter-box">
        <label>
            <input type="checkbox" id="filter-sparkling">
            –ò–≥—Ä–∏—Å—Ç–æ–µ
        </label>
    </div>
</div>

<p>–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–û—Ç–∫—Ä—ã—Ç—å PDF¬ª ‚Äî –≤—Å—ë –∫–æ–Ω—Ñ–µ—Ç–∫–∞ üç∑‚ú®</p>
<div class="wine-list"></div>
<div class="wine-list-sorted"></div>

<p>–≤–µ—Ä—Å–∏—è —Å–∞–π—Ç–∞: 1.1a</p>
<p>winelink —Å–¥–µ–ª–∞–Ω —Å –¥—É—à–æ–π <span style="font-weight:700">Lavroovich-–µ–º</span></p>

<script>
// –º–∞–ø—ã
const countryMap = { 
    russia:"üá∑üá∫ –†–æ—Å—Å–∏—è", usa:"üá∫üá∏ –°–®–ê", ukraine:"üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞", france:"üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è", italy:"üáÆüáπ –ò—Ç–∞–ª–∏—è", 
    spain:"üá™üá∏ –ò—Å–ø–∞–Ω–∏—è", germany:"üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è", new_zealand:"üá≥üáø –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è", georgia:"üá¨üá™ –ì—Ä—É–∑–∏—è", 
    brazil:"üáßüá∑ –ë—Ä–∞–∑–∏–ª–∏—è", australia:"üá¶üá∫ –ê–≤—Å—Ç—Ä–∞–ª–∏—è", aurstria:"üá¶üáπ –ê–≤—Å—Ç—Ä–∏—è", argentina:"üá¶üá∑ –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞", 
    south_africa:"üáøüá¶ –Æ–∂–Ω–∞—è –ê—Ñ—Ä–∏–∫–∞", serbia: "üá∑üá∏ –°–µ—Ä–±–∏—è" 
};
const colorMap = { red:"–ö—Ä–∞—Å–Ω–æ–µ", white:"–ë–µ–ª–æ–µ", pink:"–†–æ–∑–æ–≤–æ–µ" };
const sugarMap = { dry:"–°—É—Ö–æ–µ", semidry:"–ü–æ–ª—É—Å—É—Ö–æ–µ", brut: "–ë—Ä—é—Ç" , sweet:"–°–ª–∞–¥–∫–æ–µ" };

// –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–±–ª–æ–Ω–∞
const allVines = {{ vines|tojson }};

// —Ñ–∏–∫—Å –¥–ª—è undefined sparkling
allVines.forEach(v => { if(!v.sparkling) v.sparkling = "no"; });

const list = document.querySelector('.wine-list');
const sortedList = document.querySelector('.wine-list-sorted');

const selects = { 
    country: document.querySelector('#filter-country'), 
    color: document.querySelector('#filter-color'), 
    region: document.querySelector('#filter-region'), 
    grape: document.querySelector('#filter-grape'),
    sugar: document.querySelector('#filter-sugar')
};

let filteredVines = allVines.slice();

// —É—Ç–∏–ª–∏—Ç—ã
function getUniqueValues(vines, field){ 
    if(field==="grape") return [...new Set(vines.flatMap(v=>v.grape||[]))]; 
    return [...new Set(vines.map(v=>v[field]).filter(x=>x))]; 
}
function getSelectedValues(select){ return Array.from(select.selectedOptions).map(o=>o.value); }

function populateSelect(select, values, map){ 
    const current = getSelectedValues(select);
    select.innerHTML = '';
    values.sort((a,b)=>{
        const textA = (map ? map[a] || a : a).toString().toLowerCase();
        const textB = (map ? map[b] || b : b).toString().toLowerCase();
        return textA.localeCompare(textB, 'ru');
    });
    values.forEach(val=>{
        const option=document.createElement('option');
        option.value=val;
        option.textContent=map?map[val]||val:val;
        if(current.includes(val)) option.selected=true;
        select.appendChild(option);
    });
}

function animateCards(cards){ 
    cards.forEach((c,i)=>setTimeout(()=>c.classList.add('show'), i*40)); 
}

// --- –ù–û–í–´–ô —Ä–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫: —É–ª—É—á—à–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω + id ---
function renderVines(vines){
    list.innerHTML='';
    if(!vines.length){ list.innerHTML='<p style="text-align:center;font-weight:bold;">–í—Å—ë ‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üò¢</p>'; return; }
    const cards=[];
    vines.forEach(v=>{
        const grapes = v.grape && v.grape.length ? v.grape.join(", ") : "‚Äî";
        const sugar = sugarMap[v.sugar] || v.sugar || "‚Äî";
        const id = (v.id !== undefined && v.id !== null) ? v.id : '‚Äî';

        const card = document.createElement('div'); 
        card.className='wine-card';
        if(v.sparkling==="yes") card.classList.add('sparkling'); // –≤—ã–¥–µ–ª—è–µ–º –∏–≥—Ä–∏—Å—Ç–æ–µ
        // dataset id ‚Äî –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
        card.dataset.id = id;
        card.dataset.pdf = v.pdf_file || '';

        card.innerHTML = `
          <div class="card-left">
            <div class="id-badge">ID: <strong>${id}</strong></div>
            <div class="icon-pdf" title="–û—Ç–∫—Ä—ã—Ç—å PDF" role="img" aria-label="PDF">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 2h7l5 5v13a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z" stroke="#c33" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="#fff"/><path d="M13 2v6h6" stroke="#c33" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div class="copy-id" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID">–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</div>
          </div>
          <div class="card-content">
            <div class="card-top">
              <h3 class="wine-name">${escapeHtml(v.name || '‚Äî')}</h3>
              ${v.sparkling==="yes"?'<div class="sparkling-pill">–ò–≥—Ä–∏—Å—Ç–æ–µ</div>':''}
            </div>
            <div class="main-info">${countryMap[v.country]||escapeHtml(v.country||'‚Äî')} ‚Ä¢ ${colorMap[v.color]||escapeHtml(v.color||'‚Äî')} ‚Ä¢ ${escapeHtml(sugar)}</div>
            <div class="extra-info">–†–µ–≥–∏–æ–Ω: ${escapeHtml(v.region||'‚Äî')} | –°–æ—Ä—Ç –≤–∏–Ω–æ–≥—Ä–∞–¥–∞: ${escapeHtml(grapes)}</div>
            <div class="card-bottom">
              <button class="btn btn-open" data-pdf-open>–û—Ç–∫—Ä—ã—Ç—å PDF</button>
              <button class="btn btn-more">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
            </div>
          </div>
        `;

        // –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç pdf
        card.addEventListener('click', ()=>{
            if(card.dataset.pdf) window.open('/vinery/'+card.dataset.pdf, '_blank');
        });

        // –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å id ‚Äî –±–µ–∑ –≤—Å–ø–ª—ã—Ç–∏—è –∫–ª–∏–∫–∞
        const copyBtn = card.querySelector('.copy-id');
        copyBtn.addEventListener('click', (e)=>{ e.stopPropagation();
            const text = card.dataset.id || '';
            if(text) navigator.clipboard?.writeText(text.toString()).then(()=>{
                copyBtn.textContent = '—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì';
                setTimeout(()=> copyBtn.textContent = '–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID', 1200);
            }).catch(()=>{ copyBtn.textContent = '–æ—à–∏–±–∫–∞'; setTimeout(()=> copyBtn.textContent = '–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID', 1200); });
        });

        // –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å PDF (–æ–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ ‚Äî —Ç–æ–∂–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ)
        const openPdfBtn = card.querySelector('[data-pdf-open]');
        openPdfBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if(card.dataset.pdf) window.open('/vinery/'+card.dataset.pdf, '_blank'); });

        // –ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å. –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –≤—Å–ø–ª—ã–≤–∞—à–∫–∞
        const moreBtn = card.querySelector('.btn-more');
        moreBtn.addEventListener('click', (e)=>{ e.stopPropagation(); alert(`–í–∏–Ω–æ: ${v.name}\nID: ${id}\n–†–µ–≥–∏–æ–Ω: ${v.region||'‚Äî'}`); });

        list.appendChild(card); 
        cards.push(card);
    });
    requestAnimationFrame(()=>animateCards(cards));
}

// –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π renderSortedVines: —Ç–æ–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º id –≤ sub-–∫–∞—Ä—Ç–æ—á–∫–∏
function renderSortedVines(vines,criterion){
    sortedList.innerHTML=''; if(!criterion) return;

    let primaryKey='country', secondaryKey='color', secondaryMap=colorMap;
    const groups={};
    vines.forEach(v=>{
        const pKey = v[primaryKey]||'‚Äî';
        const sKey = v[secondaryKey]||'‚Äî';
        groups[pKey] = groups[pKey]||{};
        groups[pKey][sKey] = groups[pKey][sKey]||[];
        groups[pKey][sKey].push(v);
    });

    Object.keys(groups).sort((a,b)=>Object.values(groups[b]).flat().length-Object.values(groups[a]).flat().length).forEach(pKey=>{
        const primaryTitle = document.createElement('div'); primaryTitle.className='group-title'; primaryTitle.textContent = countryMap[pKey]||pKey; sortedList.appendChild(primaryTitle);

        Object.keys(groups[pKey]).sort((a,b)=>groups[pKey][b].length-groups[pKey][a].length).forEach(sKey=>{
            const secondaryTitle = document.createElement('div'); secondaryTitle.className='group-title sub'; secondaryTitle.textContent = secondaryMap[sKey]||sKey; sortedList.appendChild(secondaryTitle);

            groups[pKey][sKey].forEach(v=>{
                const grapes=v.grape&&v.grape.length?v.grape.join(", "):"‚Äî";
                const sugar = sugarMap[v.sugar] || v.sugar || "‚Äî";
                const id = (v.id !== undefined && v.id !== null) ? v.id : '‚Äî';
                const card=document.createElement('div'); card.className='wine-card sub'; if(v.sparkling==="yes") card.classList.add('sparkling');
                card.dataset.id = id; card.dataset.pdf = v.pdf_file || '';
                card.innerHTML=`<div style="flex:1"><strong>${escapeHtml(v.name||'‚Äî')}</strong><div style="font-size:0.86rem;color:${'var(--muted)'}">${countryMap[v.country]||escapeHtml(v.country||'‚Äî')} ‚Ä¢ ${colorMap[v.color]||escapeHtml(v.color||'‚Äî')} ‚Ä¢ ${escapeHtml(sugar)}</div><div style="font-size:0.8rem;color:${'var(--muted)'}">–†–µ–≥–∏–æ–Ω: ${escapeHtml(v.region||'‚Äî')} | ${escapeHtml(grapes)} ‚Ä¢ ID: <strong>${id}</strong></div></div>`;
                card.addEventListener('click', ()=>{ if(card.dataset.pdf) window.open('/vinery/'+card.dataset.pdf,'_blank'); });
                sortedList.appendChild(card);
                requestAnimationFrame(()=>card.classList.add('show'));
            });
        });
    });
}

// —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –Ω–æ —á—É—Ç—å –ø–æ—á–∏—â–µ
function filterVines(){
    list.innerHTML=''; sortedList.innerHTML='';
    const name = document.querySelector('#filter-name').value.toLowerCase();
    const countries = getSelectedValues(selects.country);
    const colors = getSelectedValues(selects.color);
    let regions = getSelectedValues(selects.region);
    const grapes = getSelectedValues(selects.grape);
    const sugars = getSelectedValues(selects.sugar);
    const sparklingChecked = document.querySelector('#filter-sparkling').checked;

    const allowedRegions = allVines
        .filter(v => (!sparklingChecked || v.sparkling==="yes") && (countries.length===0 || countries.includes(v.country)))
        .map(v=>v.region).filter(r=>r);
    regions = regions.filter(r=>allowedRegions.includes(r));

    filteredVines = allVines.filter(v=>
        (!name || (v.name||'').toLowerCase().includes(name)) &&
        (countries.length===0 || countries.includes(v.country)) &&
        (colors.length===0 || colors.includes(v.color)) &&
        (regions.length===0 || regions.includes(v.region)) &&
        (grapes.length===0 || (v.grape||[]).some(g=>grapes.includes(g))) &&
        (sugars.length===0 || sugars.includes(v.sugar)) &&
        (!sparklingChecked || v.sparkling==="yes")
    );

    populateSelect(selects.region, [...new Set(allowedRegions)]);
    renderVines(filteredVines);
    updateSorted();
}

function updateSorted(){ list.style.display='none'; sortedList.style.display='flex'; renderSortedVines(filteredVines,"country+color"); }

function updateColorHighlight(){
    const colorBox=document.getElementById('filter-color-box');
    colorBox.classList.remove("red-highlight","white-highlight","pink-highlight");
    const colors=getSelectedValues(selects.color);
    if(colors.includes("red")) colorBox.classList.add("red-highlight");
    else if(colors.includes("white")) colorBox.classList.add("white-highlight");
    else if(colors.includes("pink")) colorBox.classList.add("pink-highlight");
}

// helper to escape user data into HTML (simple)
function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replace(/[&<>"']/g, function(ch){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[ch]; }); }

// init
populateSelect(selects.country,getUniqueValues(allVines,'country'),countryMap);
populateSelect(selects.color,getUniqueValues(allVines,'color'),colorMap);
populateSelect(selects.region,getUniqueValues(allVines,'region'));
populateSelect(selects.grape,getUniqueValues(allVines,'grape'));
populateSelect(selects.sugar,getUniqueValues(allVines,'sugar'),sugarMap);

renderVines(allVines);
updateSorted();

document.querySelectorAll('.filters input, .filters select').forEach(el=>{
    el.addEventListener('input',()=>{ filterVines(); updateColorHighlight(); });
});
</script>
</main>
</body>
</html>